---
title: "Biocore_scRNAseq"
geometry: margin=0.5cm
author: "Kyle Gellatly"
output:
  html_document:
    toc: true
    toc_float : yes
    toc_depth : 4
    theme : cerulean
---

```{r setup, include=FALSE, warning=FALSE, error=FALSE}
knitr::opts_chunk$set(echo = TRUE, comment = "")
```


```{r, include=FALSE, cache=FALSE, warning=FALSE, error=FALSE}
library("SignallingSingleCell")
load(url("https://galaxyweb.umassmed.edu/pub/class/mDC_UMI_Table.Rdata"))
load(url("https://galaxyweb.umassmed.edu/pub/class/ex_sc_skin.Rdata"))
```

# Preprocessing  

## Constructing the ExpressionSet Class  

The ExpressionSet class (ex_sc) is a convenient data structure that contains 3 dataframes. These dataframes contain expression data, cell information, and gene information respectively. 

exprs(ex_sc) is the expression data, where rows are genes and columns are cells  
pData(ex_sc) is cell information, where rows are cells and columns are metadata  
fData(ex_sc) is gene information, where rows are genes and columns are metadata

```{r, include=TRUE, cache=FALSE, warning=FALSE, error=FALSE}
ex_sc <- construct_ex_sc(mDC_UMI_Table) # sc_dat == Input expression matrix
ex_sc # Note that phenoData and featureData are empty right now!

ex_sc_skin

exprs(ex_sc)[1:5,1:5]
pData(ex_sc)[1:5,]
fData(ex_sc)[1:5,]
rm(mDC_UMI_Table)
```

## Data Annotation

Often we have metadata about the experiment that can be valuable in the analysis! Writing that information now may be appropriate. Our experiment consists of a time course with LPS stimulation.

```{r, include=TRUE, cache=FALSE, warning=FALSE, error=FALSE}
pData(ex_sc)$Timepoint <- NA # initialize a new pData column

pData(ex_sc)[grep("0hr", rownames(pData(ex_sc))),"Timepoint"] <- "0hr"
pData(ex_sc)[grep("1hr", rownames(pData(ex_sc))),"Timepoint"] <- "1hr"
pData(ex_sc)[grep("4hr", rownames(pData(ex_sc))),"Timepoint"] <- "4hr"

head(pData(ex_sc))
```

## Filtering

The first step is to filter your data to remove low quality cells. Often creating a histogram of the values and assigning cutoffs is simple and effective. Typically we remove all cells lower than 500-1000 UMIs / cell.

```{r, include=TRUE, cache=FALSE, warning=FALSE, error=FALSE}
ex_sc <- calc_libsize(ex_sc, suffix = "raw") # sums counts for each cell

ex_sc <- pre_filter(ex_sc, minUMI = 1000, maxUMI = 10000, threshold = 1, minCells = 10,  print_progress = TRUE) # filters cells and genes

ex_sc <- calc_libsize(ex_sc, suffix = "raw_filtered")
plot_density(ex_sc, title = "UMI Density",  val = "UMI_sum_raw_filtered", statistic = "mean")  

```

# Basic scRNA-seq analysis  

## Dimension reduction

Dimensionality reduction is necessary in order to bring the cells from a high dimensional gene expression space (~10k dimensions) down to a more reasonable number. Typically this is done first with PCA ~5-15 dimensions, before a final embedding is done using tSNE or UMAP to bring it down to 2 dimensions. 

```{r, include=TRUE, cache=FALSE, warning=FALSE, error=FALSE}
gene_subset <- subset_genes(ex_sc, method = "PCA", threshold = 1, minCells = 20, nComp = 10, cutoff = 0.85) 

ex_sc <- dim_reduce(ex_sc, genelist = gene_subset, pre_reduce = "iPCA", nComp = 10, tSNE_perp = 30, iterations = 500, print_progress=TRUE) 

colnames(pData(ex_sc))

plot_tsne_metadata(ex_sc, color_by = "Timepoint") 

plot_tsne_metadata(ex_sc, color_by = "iPC_Comp1", title = "PC1 cell loadings") 

plot_tsne_metadata(ex_sc, color_by = "iPC_Comp2", title = "PC2 cell loadings") 

plot_tsne_metadata(ex_sc, color_by = "iPC_Comp3", title = "PC3 cell loadings") 

```

### Excersise 1 : Dimension reduction on Skin Data

Now let us try dimension for the skin data!! First we can inspect the skin data to get a sense of what we are working with. Once we get a sense for the data we can then use the same functions as above to perform gene selection and dimension reduction.

```{r, include=TRUE, cache=FALSE, warning=FALSE, error=FALSE}

dim(ex_sc_skin)

colnames(pData(ex_sc_skin))
colnames(fData(ex_sc_skin))

plyr::count(pData(ex_sc_skin))

# Use the subset_genes function to find variable genes in the skin data. Be sure to provide the input argument and method argument. Use ?subset_genes() to view help pages for functions. Try different methods and compare the number of genes you get out for each method.

gene_subset <- subset_genes(ex_sc_skin, method = "PCA", threshold = 1, minCells = 30)

# Use the dim_reduce function to create a 2D representation of the skin data. Be sure to provide the input argument and a gene list.

ex_sc_skin <- dim_reduce(ex_sc_skin, genelist = gene_subset, pre_reduce = "iPCA", nComp = 10, iterations = 500)

# Now you can plot metadata from pData() or genes of interest, onto the tSNE mapping.

plot_tsne_metadata(ex_sc_skin, color_by = "Patient", facet_by = "Skin")

```

## Clustering

Now that we have dimension reduced data we can try clustering it! For dimensions, both Comp and 2d are supported. There will determine if the clustering is done on principal components, or on the 2D representation. There are also 2 clustering algorithms available, density and spectral. Typically we recommend spectral clustering on PCA components, or density clustering on the 2d representation. Try both!

```{r, include=TRUE, cache=FALSE, warning=FALSE, error=FALSE}

ex_sc <- cluster_sc(ex_sc, dimension = "Comp", method = "spectral", num_clust = 4) 
ex_sc$cluster_spectral <- ex_sc$Cluster

ex_sc <- cluster_sc(ex_sc, dimension = "2d", method = "density", num_clust = 4) 
ex_sc$cluster_density <- ex_sc$Cluster

plot_tsne_metadata(ex_sc, color_by = "cluster_spectral")
plot_tsne_metadata(ex_sc, color_by = "cluster_density")

```

### Excercise 2 : Clustering on the Skin Data

Now let us try clustering for the skin data!! Try both density based and spectral clustering!

```{r, include=TRUE, cache=FALSE, warning=FALSE, error=FALSE}

ex_sc_skin <- cluster_sc(ex_sc_skin, dimension = "Comp", method = "spectral", num_clust = 4) 

plot_tsne_metadata(ex_sc_skin, color_by = "Cluster")


```

## Cell Type Identification

There are many possible ways to identify cell types based on their gene expression. The id_markers function will identify genes that are highly expressed in a high proportion of a given cluster, relative to the other clusters.

```{r, include=TRUE, cache=FALSE, warning=FALSE, error=FALSE}
ex_sc <- id_markers(ex_sc, print_progress = TRUE) # This is a quick method to find good markers genes for cell identification. These gene scores get written to fData()

ex_sc <- calc_agg_bulk(ex_sc, aggregate_by = "Cluster")

markers <- return_markers(ex_sc, num_markers = 15) 

plot_heatmap(ex_sc, genes = unique(unlist(markers)), type = "bulk")
```

### Excercise 3 : Cell Type identification Skin Data

Now try to identify the cell types in the skin data!

```{r, include=TRUE, cache=FALSE, warning=FALSE, error=FALSE}

# ex_sc_skin <- id_markers()

# markers <- return_markers() 

# ex_sc_skin <- calc_agg_bulk()

# plot_heatmap()

```

## Normalization

Now that the data has preliminary clusters, we can normalize. SCRAN normalization will first normalize internally in clusters, before normalizing across clusters. Once the data is normalized we can run the same steps as above before visualization. The first step is to select the genes to be used for normalization. One method would be to first only use genes expressed in more than n cells, and then remove the most variable genes. This method can be computationally expensive, and is currently commented out. A simpler approach, counts per million, is also provided below.

```{r, include=TRUE, cache=FALSE, warning=FALSE, error=FALSE}
table(pData(ex_sc)$Cluster)

# ex_sc_norm <- norm_sc(ex_sc, pool_sizes = c(20,25,30,35,40))

x <- exprs(ex_sc)
cSum <- apply(x,2,sum)    # recompute for remaining cells
x <- as.matrix(sweep(x,2,cSum,FUN='/'))*1e6    # normalize to UMIs per million
ex_sc_norm <- construct_ex_sc(x)
pData(ex_sc_norm) <- pData(ex_sc)
```

### Excercise 4 : Process the normalized mouse data!

Now that we have normalized, it is time to reprocess the data as before, this time on the normalized counts! Use the ex_sc_norm normalized counts from above to run through the same processing steps as before.

```{r, include=TRUE, cache=FALSE, warning=FALSE, error=FALSE}

# gene_subset <- subset_genes()

# ex_sc_norm <- dim_reduce()

# ex_sc_norm <- cluster_sc()

# plot_tsne_metadata()

# plot_tsne_gene()

```

# Advanced scRNA-seq analysis  

## Supervised Analysis

From the above analysis, it is clear that some clusters are formed based on their cell type, while others are based on their experimental condition. In these cases it can be useful to incorporate prior information in order to obtain clusters and annotations that are grounded in biological significance. Below, we can assign "panels" similar to flow cytometry, that will enable cell groupings based on the expression of genes that you believe to signify biologically relevenant cell types.

```{r, error=FALSE, warning=FALSE, cache=FALSE, include=TRUE}

panel1 <- c("S100a9", "Lcn2") # Neutrophil Markers
panel2 <- c("Ccr7", "Fscn1") # DC
panel3 <- c("Csf1r", "Mertk") # Mac

panels <- list(panel1, panel2, panel3)

plot_tsne_gene(ex_sc_norm, gene = unlist(panels), title = "", log_scale = T)

names(panels) <- c("Neutrophil", "Dendritic", "Macrophage")

ex_sc_norm <- flow_filter(ex_sc_norm, panels = panels, title = "Flow Pass Cells")

ex_sc_norm <- flow_svm(ex_sc_norm, pcnames = "Comp")

plot_tsne_metadata(ex_sc_norm, color_by = "cluster_spectral", title = "Spectral Cluster on PCA components")
plot_tsne_metadata(ex_sc_norm, color_by = "SVM_Classify", title = "Spectral Cluster on PCA components")

```

## DE analysis

Now that cells are grouped by their cell type, we can run DE in order to determine which genes are change in association with our experimental conditions. 

For simplicity we can subset to 0hr and 4hr, to  find the genes that change between these conditions.

It should be noted that DE should always be run on raw counts, not on the normalized counts!

```{r, error=FALSE, warning=FALSE, cache=FALSE, include=TRUE}

ex_sc_norm_0_4 <- subset_ex_sc(ex_sc_norm, variable = "Timepoint", select = c("0hr", "4hr"))

findDEgenes(input = ex_sc,
            pd = pData(ex_sc_norm_0_4),
            DEgroup = "Timepoint",
            contrastID = "0hr",
            facet_by = "SVM_Classify",
            outdir = "~/Downloads/")

plot_volcano(de_path = "~/Downloads/", de_file = "Macrophage_0hr_DEresults.tsv", fdr_cut = 0.000001, logfc_cut = 2)

plot_violin(ex_sc_norm_0_4, color_by = "Timepoint", facet_by = "SVM_Classify", gene = "Cxcl9")
plot_violin(ex_sc_norm_0_4, color_by = "Timepoint", facet_by = "SVM_Classify", gene = "Rsad2")

```

### Homework

Now try to run DE between the 0hr and 1hr timepoints on the mouse data. Then make a volcano plot of the genes that are significantly changed (FDR < 0.001, logfc_cut >= 2) within Dendritic cells.

```{r, error=FALSE, warning=FALSE, cache=FALSE, include=TRUE}

# ex_sc_norm_0_1 <- subset_ex_sc()

# findDEgenes() 

# plot_volcano()

```
